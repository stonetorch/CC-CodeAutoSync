# CodeSync - Minecraft ComputerCraft 代码同步系统

## 系统概述

CodeSync 是一套为 Minecraft ComputerCraft 模组开发的自动化代码同步系统。它允许在一个中央服务器上管理代码，并自动将更新同步到网络中的多个客户端计算机。

## 核心功能

- **自动代码分发**：从服务器计算机向网络中的客户端计算机自动分发代码文件
- **实时代码更新**：检测服务器端文件变化并自动推送更新到客户端
- **无缝代码注入**：通过钩子技术在不改变原始程序逻辑的情况下实现更新
- **分段文件传输**：支持大文件的分段传输，克服 ComputerCraft 调制解调器的传输限制
- **版本控制**：维护文件版本和校验和信息，确保只更新已变更的文件
- **自动重启**：客户端可配置在代码更新后自动重启程序
- **状态监控**：服务器可监控客户端的在线状态和文件运行情况

## 安装步骤

### 服务器安装

1. 在服务器计算机上保存以下文件：

   - `/codeSync_server.lua`
   - `/startup/autoSync.lua`

2. 重启计算机，服务器将自动启动

### 客户端安装

1. 在客户端计算机上保存以下文件：

   - `/codeSync_client.lua`
   - `/codeSync_hook_code.lua`
   - `/startup/autoSyncClient.lua`

2. 重启计算机，客户端将自动启动并连接到服务器

## 使用方法

### 服务器命令

服务器程序提供以下命令行接口：

- `add <计算机ID> <文件路径> [自动重启=true]` - 添加目标计算机和要分发的文件
- `remove <计算机ID>` - 移除目标计算机
- `list` - 列出所有目标计算机及其文件
- `sync <计算机ID> [文件路径]` - 同步文件到指定计算机
- `syncall` - 同步所有文件到所有计算机
- `scan` - 扫描所有文件并更新元数据
- `help` - 显示帮助信息
- `exit` - 退出程序

## 工作原理

### 代码同步流程

1. **文件监控**：服务器持续监控指定的文件变化
2. **更新检测**：当文件发生变化时，服务器更新文件的版本号和校验和
3. **文件分发**：服务器将文件分段发送到指定的客户端计算机
4. **文件重组**：客户端接收所有分段并重组文件
5. **代码注入**：客户端将钩子代码注入到目标文件中
6. **程序更新**：根据配置，客户端可能会自动重启程序以应用更新

### 代码注入原理

CodeSync 使用代码注入技术实现无缝更新：

1. CodeSync 的主要功能会被注入到目标程序中，当目标程序运行时，CodeSync 会通过替换 `os.pullEvent` 和 `os.pullEventRaw` 函数来监听网络消息
2. 当检测到更新时，钩子代码可以优雅地终止当前程序并重启应用新代码
3. 支持两种注入模式：
   - **替换模式**：直接替换原有事件函数，这适用于程序自带事件监听器的情况。
   - **旁路加载模式**：并行运行旁路事件监听器和原程序

## 系统限制

- 某些复杂程序可能与钩子机制不兼容
- 调制解调器的通信范围有限
- 大文件传输可能需要较长时间

## 高级配置

- 修改 `BROADCAST_CHANNEL`、`RESPONSE_CHANNEL` 和 `REQUEST_CHANNEL` 变量可更改通信频道
- 调整 `MAX_CHUNK_SIZE` 可优化文件分段大小
- 编辑钩子代码可实现自定义更新行为
